<!DOCTYPE html>
<html>
  	<head>
  		 <script type="text/javascript">
         var host = "www.zhresearches.com";
            if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
        </script>
          <title>A developer's wonder garden</title>
  		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
  		<meta name="description" content="My Journal to become a better developer. " />
  		<meta name="keywords" content="blog developer C# .net artecheture" />
        <link rel="cononical" href="https://www.zhresearches.com/"/>
  		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
  		<script src="/js/jquery.min.js"></script>
  		<script src="/js/jquery.poptrox.min.js"></script>
  		<link rel="stylesheet" href="css/font-awesome.min.css"/>
  		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic"/>
  	    <link rel="stylesheet" href="/css/main.css" />
  		<!--[if lte IE 8]><link rel="stylesheet" href="/css/ie/v8.css" /><![endif]-->

  	</head>

	<body id="top">

      <header id="header">
          <a href="#" class="image avatar"><img src="/images/avatar.jpg" alt="" /></a>
          <h1> 
               The Journal to become a better developer
          </h1>
      </header>

    <div id="main">
    <!-- Main -->
<div id="main">
    <section>
        
            <header class="major">
                <h2>azure service fabric deply anywhere</h2>
                <p class="post-meta">Jun 29, 2016</p>
            </header>

            <section>
                <p>This post I will discuss the setup I used for my research on microsoft azure service fabric on premise.</p>

<!-- more -->

<p>I don’t have the luxury to have multiple computers readily avaiable so I route to use virtual machines that I can spin off on my box where I have 32G memory that is enough for 3 nodes with minimum
configuration recomened by Microsoft. Naturally, the <em>Vagrant</em> is my choice since the windows server dependence.</p>

<blockquote>
  <p>Preparation</p>
</blockquote>

<p>First of all, I have to a window base box. I created a base box based on windows server 2012 r2 using a tool called <em>packer</em>.  The <a href="http://www.developer.com/net/virtualize-your-windows-development-environments-with-vagrant-packer-and-chocolatey-part-1.html">blog</a> is the good resource to get it setup</p>

<blockquote>
  <p>Cluster setting</p>
</blockquote>

<p>For my testing, I opted for the samplest cluster which inculdes 3 nodes spreading into 3 update domains and fault domains. The service bus provides the load balance inside its services, however, a 
external load balancer needed for any trafic outside to communicate with service fabric appliations, which I assume all communication happens through APIs via http.</p>

<p>Now the code/scripts.</p>

<blockquote>
  <p>Vagrantfile</p>
</blockquote>

<p>we need 3 vms</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    (1..3).each do |i|
    root.vm.define "node-#{i}" do |config|
    end
</code></pre>
</div>

<p>that are derived for my base box named <em>WinServerBase</em> and provide default user</p>

<div class="highlighter-rouge"><pre class="highlight"><code>        config.vm.box = "WinServerBase"
        config.vm.communicator = "winrm"

        config.winrm.username = "vagrant"
        config.winrm.password = "vagrant"

        config.vm.guest = :windows
        config.windows.halt_timeout = 15
</code></pre>
</div>

<p>let’s set the network</p>

<div class="highlighter-rouge"><pre class="highlight"><code>        config.vm.network :forwarded_port, guest: 3389, host: 3389, id: "rdp", auto_correct: true
        config.vm.network :forwarded_port, guest: 22, host: 2222, id: "ssh", auto_correct: true

        config.vm.hostname="node#{i}"
        config.vm.network "private_network", ip: "192.168.100.#{i}0" ,virtualbox__intnet: true
</code></pre>
</div>

<p>it is turn for adjusting the vm</p>

<div class="highlighter-rouge"><pre class="highlight"><code>        config.vm.provider "virtualbox" do |vb|
            vb.memory = "2048"         
            vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
            vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
        end
</code></pre>
</div>

<p>now we don’t want to install runtime manually for provision vms</p>

<div class="highlighter-rouge"><pre class="highlight"><code>        config.vm.provision "shell",path:"installCplusRuntime.cmd"
        config.vm.provision :shell, path:"disable-firewall.ps1"
        if i==3
           config.vm.provision :shell, path:"configure-cluster.ps1"
        end
</code></pre>
</div>

<p>here we disable the firewall altogether, install the c++ runtime. Once the last vm is up, we start the setup of azure service fabric cluster</p>

<p>Did you forget the load balancer? No, here is it. I chose haproxy on a ubuntu.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>oot.vm.define "loadbalancer" do |ubuntu|
        ubuntu.vm.box="ubuntu/trusty64"
        ubuntu.vm.communicator ="ssh"
        ubuntu.vm.network "private_network", ip: "192.168.100.1" ,virtualbox__intnet: true
        
        ubuntu.vm.network :forwarded_port, guest:8898, host:18898,id:"apiGateWay",auto_correct:true
        ubuntu.vm.network :forwarded_port, guest:19080, host:18080,id:"httpGateWay",auto_correct:true
        ubuntu.vm.network :forwarded_port, guest:19000, host:18000,id:"clientconnectionEndpoint",auto_correct:true
        ubuntu.vm.network :forwarded_port, guest:8081, host:18081,id:"clusterStatus",auto_correct:true
        ubuntu.vm.network :forwarded_port, guest:80, host:18888,id:"http",auto_correct:true
        ubuntu.vm.network :forwarded_port, guest:1936, host:11936,id:"haproxy",auto_correct:true

        ubuntu.ssh.insert_key = false
        $script = &lt;&lt;SCRIPT
        add-apt-repository ppa:vbernat/haproxy-1.5
        apt-get update
        echo 'install haproxy'
        apt-get install haproxy
        cp /vagrant/haproxy.cfg /etc/haproxy/haproxy.cfg
        service haproxy restart
SCRIPT
        ubuntu.vm.provision "shell", inline: $script
   end
</code></pre>
</div>

<blockquote>
  <p>Get cluster up</p>
</blockquote>

<p>now show time!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>   vagarnt up
</code></pre>
</div>

<p>I did not include other scripts that you can find at this <a href="https://gist.github.com/zhangxd6/d5017c706375b6ce1c4e5c83da0c5c12">gist</a></p>


            </section>
        
    </section>
    <section>
        <div class="row">
            

                <article class="6u 12u(small)">
                    <header>
                        <h2><a href="/2016/06/28/virtualize-your-dev-enviroment.html">virtualize your dev environment</a></h2>
                    </header>
                    <section>
                        <p>It is crucial for developers to be authoring code and test it in a production-like environment. Asking extra hardware most time is cost prohibited route, fortunately, virtualization and containerization provide developers with sufficient tools to manage this. This post will focus on the Vagrant to establish virtual machines on window os.</p>

<!-- more-->

<blockquote>
  <p>Create a base box</p>
</blockquote>

<p>following the <a href="http://www.developer.com/net/virtualize-your-windows-development-environments-with-vagrant-packer-and-chocolatey-part-1.html">instruction</a> to set up the base window server 2012 r2 image.
  <em>note</em>: you have to enable the VT_X(virtualization) in bios to able to use virtual box</p>

<blockquote>
  <p>Add base box</p>
</blockquote>

<p><code class="highlighter-rouge">vagrant box add WinServerBase C:\Mydata\Virtual\windows_2012_r2_virtualbox.box</code></p>

<blockquote>
  <p>Start base box</p>
</blockquote>

<p><code class="highlighter-rouge">vagrant init WinServerBase</code></p>

<p><code class="highlighter-rouge">vagrant up</code></p>

<p><code class="highlighter-rouge">vagrant rdp</code></p>

<blockquote>
  <p>Prevision</p>
</blockquote>

<p>you will need to modify the Vagrantfile to provision the virtual box to host the website or other applications, like</p>

<p><code class="highlighter-rouge"> config.vm.provision "shell",path:"installCplusRuntime.cmd"
config.vm.provision :shell, path:"disable-firewall.ps1"</code></p>


                    </section>
                    <footer>
                        <ul class="actions">
                            <li><a href="/2016/06/28/virtualize-your-dev-enviroment.html" class="button">Read More</a></li>
                        </ul>
                    </footer>
                </article>

            
        </div>
    </section>
</div>

    </div>
        <!-- Footer -->
        <footer id="footer">
            <ul class="icons">

              
              <li>
                <a href="https://github.com/zhangxd6" class="icon fa-github">
                  <span class="label">GitHub</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://twitter.com/zhangxd6" class="icon fa-twitter">
                  <span class="label">Twitter</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://linkedin.com/in/xiangdong-zhang-1b89923" class="icon fa-linkedin">
                  <span class="label">LinkedIn</span>
                </a>
              </li>
              

              

              

              

              
              <li>
                <a href="mailto:xzhang@zhresearches.com" class="icon fa-envelope-o">
                  <span class="label">Email</span>
                </a>
              </li>
              
            </ul>
       </footer>

	</body>
</html>